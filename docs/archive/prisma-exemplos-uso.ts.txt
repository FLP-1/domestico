/**
 * üìö Exemplos de Uso - Prisma ORM
 * Sistema DOM
 * 
 * Este arquivo cont√©m exemplos pr√°ticos de uso do Prisma
 */

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// ==========================================
// 1Ô∏è‚É£ CRIA√á√ÉO DE USU√ÅRIO COMPLETO
// ==========================================

async function criarUsuarioCompleto() {
  try {
    // Dados sem m√°scara
    const cpfLimpo = '12345678901' // J√° sem m√°scara
    const telefoneLimpo = '11999999999' // J√° sem m√°scara
    const cepLimpo = '01234567' // J√° sem m√°scara

    const usuario = await prisma.usuario.create({
      data: {
        // Dados obrigat√≥rios
        cpf: cpfLimpo,
        nomeCompleto: 'Jo√£o da Silva',
        apelido: 'Jo√£o',
        dataNascimento: new Date('1990-01-15'),
        email: 'joao@email.com',
        telefone: telefoneLimpo,
        
        // Endere√ßo
        logradouro: 'Rua das Flores',
        numero: '123',
        complemento: 'Apto 45',
        bairro: 'Centro',
        cidade: 'S√£o Paulo',
        uf: 'SP',
        cep: cepLimpo,
        
        // Autentica√ß√£o
        senhaHash: 'hash_da_senha_aqui',
        salt: 'salt_aqui',
        
        // LGPD
        consentimentoLGPD: true,
        dataConsentimento: new Date(),
        termosAceitos: true,
        versaoTermos: 'v1.0.0',
        
        // Rela√ß√µes - Criar perfil junto
        perfis: {
          create: {
            perfilId: 'id-do-perfil-empregado',
            avatar: 'JS',
            apelido: 'Jo√£o',
            principal: true,
          }
        }
      },
      include: {
        perfis: {
          include: {
            perfil: true
          }
        }
      }
    })

    console.log('‚úÖ Usu√°rio criado:', usuario)
    return usuario

  } catch (error) {
    console.error('‚ùå Erro ao criar usu√°rio:', error)
    throw error
  }
}

// ==========================================
// 2Ô∏è‚É£ ADICIONAR PERFIL A USU√ÅRIO EXISTENTE
// ==========================================

async function adicionarPerfil(usuarioId: string, perfilId: string) {
  try {
    // Verifica se o usu√°rio j√° tem esse perfil
    const perfilExistente = await prisma.usuarioPerfil.findUnique({
      where: {
        usuarioId_perfilId: {
          usuarioId,
          perfilId,
        }
      }
    })

    if (perfilExistente) {
      throw new Error('Usu√°rio j√° possui este perfil')
    }

    // Cria novo perfil para o usu√°rio
    const novoPerfil = await prisma.usuarioPerfil.create({
      data: {
        usuarioId,
        perfilId,
        avatar: 'XX',
        ativo: true,
        principal: false,
      },
      include: {
        perfil: true,
        usuario: {
          select: {
            cpf: true,
            nomeCompleto: true,
          }
        }
      }
    })

    // Log de auditoria
    await prisma.logAuditoria.create({
      data: {
        usuarioId,
        acao: 'CREATE',
        entidade: 'UsuarioPerfil',
        entidadeId: novoPerfil.id,
        descricao: `Novo perfil ${novoPerfil.perfil.nome} adicionado ao usu√°rio`,
        tipoLog: 'DATA_MODIFICATION',
        nivelSeveridade: 'INFO',
        sucesso: true,
      }
    })

    console.log('‚úÖ Perfil adicionado:', novoPerfil)
    return novoPerfil

  } catch (error) {
    console.error('‚ùå Erro ao adicionar perfil:', error)
    throw error
  }
}

// ==========================================
// 3Ô∏è‚É£ ADICIONAR USU√ÅRIO A GRUPO (SEM DUPLICIDADE)
// ==========================================

async function adicionarUsuarioAoGrupo(usuarioId: string, grupoId: string) {
  try {
    // Verifica duplicidade
    const jaNoGrupo = await prisma.usuarioGrupo.findUnique({
      where: {
        usuarioId_grupoId: {
          usuarioId,
          grupoId,
        }
      }
    })

    if (jaNoGrupo) {
      throw new Error('Usu√°rio j√° est√° neste grupo')
    }

    // Adiciona ao grupo
    const membroGrupo = await prisma.usuarioGrupo.create({
      data: {
        usuarioId,
        grupoId,
        papel: 'MEMBRO',
        ativo: true,
      },
      include: {
        usuario: {
          select: {
            cpf: true,
            nomeCompleto: true,
          }
        },
        grupo: true,
      }
    })

    console.log('‚úÖ Usu√°rio adicionado ao grupo:', membroGrupo)
    return membroGrupo

  } catch (error) {
    console.error('‚ùå Erro ao adicionar usu√°rio ao grupo:', error)
    throw error
  }
}

// ==========================================
// 4Ô∏è‚É£ REGISTRO DE PONTO COM ANTI-FRAUDE
// ==========================================

async function registrarPonto(
  usuarioId: string,
  dispositivoId: string,
  tipo: 'ENTRADA' | 'SAIDA' | 'INTERVALO_INICIO' | 'INTERVALO_FIM',
  geolocalizacao: { latitude: number, longitude: number, precisao: number },
  dadosDispositivo: { ip: string, nomeRedeWiFi?: string }
) {
  try {
    // 1. Verificar se dispositivo √© confi√°vel
    const dispositivo = await prisma.dispositivo.findUnique({
      where: { id: dispositivoId }
    })

    if (!dispositivo || !dispositivo.confiavel) {
      throw new Error('Dispositivo n√£o confi√°vel')
    }

    // 2. Verificar geofence (exemplo simplificado)
    const dentroGeofence = verificarGeofence(
      geolocalizacao.latitude,
      geolocalizacao.longitude
    )

    // 3. Criar hash de integridade
    const hashIntegridade = criarHashIntegridade({
      usuarioId,
      dataHora: new Date(),
      tipo,
      ...geolocalizacao,
      ...dadosDispositivo,
    })

    // 4. Registrar ponto (SEMPRE com hora do servidor)
    const registroPonto = await prisma.registroPonto.create({
      data: {
        usuarioId,
        dispositivoId,
        dataHora: new Date(), // ‚ö†Ô∏è SEMPRE DO SERVIDOR
        tipo,
        latitude: geolocalizacao.latitude,
        longitude: geolocalizacao.longitude,
        precisao: geolocalizacao.precisao,
        dentroGeofence,
        enderecoIP: dadosDispositivo.ip,
        nomeRedeWiFi: dadosDispositivo.nomeRedeWiFi,
        hashIntegridade,
        aprovado: false, // Precisa aprova√ß√£o
      },
      include: {
        usuario: {
          select: {
            cpf: true,
            nomeCompleto: true,
          }
        }
      }
    })

    // 5. Log de auditoria
    await prisma.logAuditoria.create({
      data: {
        usuarioId,
        acao: 'CREATE',
        entidade: 'RegistroPonto',
        entidadeId: registroPonto.id,
        descricao: `Registro de ponto: ${tipo}`,
        enderecoIP: dadosDispositivo.ip,
        tipoLog: 'DATA_MODIFICATION',
        nivelSeveridade: 'INFO',
        sucesso: true,
        dadosNovos: {
          tipo,
          dataHora: registroPonto.dataHora,
          dentroGeofence,
        }
      }
    })

    console.log('‚úÖ Ponto registrado:', registroPonto)
    return registroPonto

  } catch (error) {
    console.error('‚ùå Erro ao registrar ponto:', error)
    throw error
  }
}

// Fun√ß√µes auxiliares
function verificarGeofence(lat: number, lng: number): boolean {
  // Implementar l√≥gica de geofence
  // Exemplo: verificar se est√° dentro de um raio de X metros
  return true
}

function criarHashIntegridade(dados: any): string {
  // Implementar cria√ß√£o de hash com crypto
  // Exemplo: SHA-256 dos dados
  return 'hash_exemplo'
}

// ==========================================
// 5Ô∏è‚É£ BUSCAR USU√ÅRIO COM TODOS OS DADOS
// ==========================================

async function buscarUsuarioCompleto(cpf: string) {
  try {
    const usuario = await prisma.usuario.findUnique({
      where: { cpf },
      include: {
        perfis: {
          include: {
            perfil: {
              include: {
                permissoes: {
                  include: {
                    funcionalidade: true
                  }
                }
              }
            }
          }
        },
        gruposUsuario: {
          include: {
            grupo: true
          }
        },
        dispositivos: true,
        documentos: {
          where: {
            validado: true
          }
        },
        tarefas: {
          where: {
            status: 'PENDING'
          }
        },
      }
    })

    if (!usuario) {
      throw new Error('Usu√°rio n√£o encontrado')
    }

    // Log de acesso (LGPD)
    await prisma.logAuditoria.create({
      data: {
        usuarioId: usuario.id,
        acao: 'READ',
        entidade: 'Usuario',
        entidadeId: usuario.id,
        descricao: 'Acesso aos dados completos do usu√°rio',
        tipoLog: 'LGPD',
        nivelSeveridade: 'INFO',
        sucesso: true,
      }
    })

    return usuario

  } catch (error) {
    console.error('‚ùå Erro ao buscar usu√°rio:', error)
    throw error
  }
}

// ==========================================
// 6Ô∏è‚É£ VERIFICAR PERMISS√ïES DO USU√ÅRIO
// ==========================================

async function verificarPermissao(
  usuarioId: string,
  funcionalidadeCodigo: string,
  tipoPermissao: 'leitura' | 'escrita' | 'exclusao' | 'admin'
) {
  try {
    // Buscar perfis do usu√°rio
    const usuarioPerfis = await prisma.usuarioPerfil.findMany({
      where: {
        usuarioId,
        ativo: true,
      },
      include: {
        perfil: {
          include: {
            permissoes: {
              include: {
                funcionalidade: true
              }
            }
          }
        }
      }
    })

    // Verificar se algum perfil tem a permiss√£o
    for (const up of usuarioPerfis) {
      const permissao = up.perfil.permissoes.find(
        p => p.funcionalidade.codigo === funcionalidadeCodigo
      )

      if (permissao) {
        switch (tipoPermissao) {
          case 'leitura':
            if (permissao.permissaoLeitura) return true
            break
          case 'escrita':
            if (permissao.permissaoEscrita) return true
            break
          case 'exclusao':
            if (permissao.permissaoExclusao) return true
            break
          case 'admin':
            if (permissao.permissaoAdmin) return true
            break
        }
      }
    }

    return false

  } catch (error) {
    console.error('‚ùå Erro ao verificar permiss√£o:', error)
    return false
  }
}

// ==========================================
// 7Ô∏è‚É£ CRIAR DOCUMENTO COM VALIDA√á√ÉO
// ==========================================

async function criarDocumento(
  usuarioId: string,
  dados: {
    nome: string
    descricao?: string
    categoria: string
    tipo: string
    tamanho: number
    caminhoArquivo: string
    dataVencimento?: Date
    tags?: string[]
  }
) {
  try {
    // Criar hash do arquivo
    const hashArquivo = 'hash_do_arquivo' // Implementar com crypto

    const documento = await prisma.documento.create({
      data: {
        usuarioId,
        nome: dados.nome,
        descricao: dados.descricao,
        categoria: dados.categoria,
        tipo: dados.tipo,
        tamanho: dados.tamanho,
        caminhoArquivo: dados.caminhoArquivo,
        hash: hashArquivo,
        dataVencimento: dados.dataVencimento,
        tags: dados.tags || [],
        permissao: 'PRIVATE',
        validado: false,
        esocialPronto: false,
        backupCriado: false,
      },
      include: {
        usuario: {
          select: {
            cpf: true,
            nomeCompleto: true,
          }
        }
      }
    })

    // Log de auditoria
    await prisma.logAuditoria.create({
      data: {
        usuarioId,
        acao: 'CREATE',
        entidade: 'Documento',
        entidadeId: documento.id,
        descricao: `Documento criado: ${dados.nome}`,
        tipoLog: 'DATA_MODIFICATION',
        nivelSeveridade: 'INFO',
        sucesso: true,
      }
    })

    console.log('‚úÖ Documento criado:', documento)
    return documento

  } catch (error) {
    console.error('‚ùå Erro ao criar documento:', error)
    throw error
  }
}

// ==========================================
// 8Ô∏è‚É£ C√ÅLCULO SALARIAL
// ==========================================

async function calcularSalario(
  cpfEmpregado: string,
  mesReferencia: number,
  anoReferencia: number,
  dados: {
    salarioBruto: number
    descontos: any[]
    proventos: any[]
  }
) {
  try {
    // Verificar se j√° existe c√°lculo
    const calculoExistente = await prisma.calculoSalarial.findUnique({
      where: {
        cpfEmpregado_mesReferencia_anoReferencia: {
          cpfEmpregado,
          mesReferencia,
          anoReferencia,
        }
      }
    })

    if (calculoExistente) {
      throw new Error('C√°lculo j√° existe para este per√≠odo')
    }

    // Calcular INSS (exemplo simplificado)
    const baseINSS = dados.salarioBruto
    const valorINSS = baseINSS * 0.11 // 11% exemplo

    // Calcular IR (exemplo simplificado)
    const baseIR = dados.salarioBruto - valorINSS
    const valorIR = baseIR > 1903.98 ? (baseIR - 1903.98) * 0.075 : 0

    // Calcular sal√°rio l√≠quido
    const totalDescontos = dados.descontos.reduce((acc, d) => acc + d.valor, 0)
    const totalProventos = dados.proventos.reduce((acc, p) => acc + p.valor, 0)
    const salarioLiquido = dados.salarioBruto + totalProventos - totalDescontos - valorINSS - valorIR

    const calculo = await prisma.calculoSalarial.create({
      data: {
        cpfEmpregado,
        mesReferencia,
        anoReferencia,
        salarioBruto: dados.salarioBruto,
        descontos: dados.descontos,
        proventos: dados.proventos,
        baseINSS,
        valorINSS,
        baseIR,
        valorIR,
        salarioLiquido,
        processado: true,
        pago: false,
      }
    })

    console.log('‚úÖ C√°lculo salarial criado:', calculo)
    return calculo

  } catch (error) {
    console.error('‚ùå Erro ao calcular sal√°rio:', error)
    throw error
  }
}

// ==========================================
// 9Ô∏è‚É£ EXPORTAR DADOS DO USU√ÅRIO (LGPD)
// ==========================================

async function exportarDadosUsuario(usuarioId: string) {
  try {
    const usuario = await prisma.usuario.findUnique({
      where: { id: usuarioId },
      include: {
        perfis: {
          include: {
            perfil: true
          }
        },
        gruposUsuario: {
          include: {
            grupo: true
          }
        },
        dispositivos: true,
        sessoes: true,
        documentos: true,
        tarefas: true,
        mensagens: true,
        pontosRegistrados: true,
        emprestimos: true,
        alertas: true,
      }
    })

    if (!usuario) {
      throw new Error('Usu√°rio n√£o encontrado')
    }

    // Log de exporta√ß√£o (LGPD)
    await prisma.logAuditoria.create({
      data: {
        usuarioId,
        acao: 'EXPORT',
        entidade: 'Usuario',
        entidadeId: usuarioId,
        descricao: 'Exporta√ß√£o de dados do usu√°rio (LGPD)',
        tipoLog: 'LGPD',
        nivelSeveridade: 'INFO',
        sucesso: true,
      }
    })

    // Retornar dados em formato JSON
    return {
      exportacao: {
        data: new Date().toISOString(),
        versao: '1.0.0',
        usuario,
      }
    }

  } catch (error) {
    console.error('‚ùå Erro ao exportar dados:', error)
    throw error
  }
}

// ==========================================
// üîü EXCLUIR DADOS DO USU√ÅRIO (LGPD)
// ==========================================

async function excluirDadosUsuario(usuarioId: string, manterLogs: boolean = true) {
  try {
    // Log antes da exclus√£o (LGPD)
    await prisma.logAuditoria.create({
      data: {
        usuarioId,
        acao: 'DELETE',
        entidade: 'Usuario',
        entidadeId: usuarioId,
        descricao: 'Solicita√ß√£o de exclus√£o de dados (LGPD)',
        tipoLog: 'LGPD',
        nivelSeveridade: 'WARNING',
        sucesso: true,
      }
    })

    // Excluir usu√°rio (cascade ir√° excluir relacionamentos)
    await prisma.usuario.delete({
      where: { id: usuarioId }
    })

    console.log('‚úÖ Dados do usu√°rio exclu√≠dos')
    
    return { sucesso: true, mensagem: 'Dados exclu√≠dos com sucesso' }

  } catch (error) {
    console.error('‚ùå Erro ao excluir dados:', error)
    throw error
  }
}

// ==========================================
// EXPORTAR FUN√á√ïES
// ==========================================

export {
  criarUsuarioCompleto,
  adicionarPerfil,
  adicionarUsuarioAoGrupo,
  registrarPonto,
  buscarUsuarioCompleto,
  verificarPermissao,
  criarDocumento,
  calcularSalario,
  exportarDadosUsuario,
  excluirDadosUsuario,
}

