// ==========================================
// üóÑÔ∏è SCHEMA PRISMA CORRIGIDO - Sistema DOM
// ==========================================
// CORRE√á√ïES APLICADAS:
// ‚úÖ Normaliza√ß√£o de Listas de Compras
// ‚úÖ Compartilhamento de Documentos
// ‚úÖ Estrutura completa conforme telas
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// üë§ TABELAS DE USU√ÅRIOS E AUTENTICA√á√ÉO
// ==========================================

model Usuario {
  id                String   @id @default(uuid())
  cpf               String   @unique @db.VarChar(11)
  
  nomeCompleto      String   @db.VarChar(255)
  apelido           String?  @db.VarChar(100)
  dataNascimento    DateTime @db.Date
  email             String   @unique @db.VarChar(255)
  emailVerificado   Boolean  @default(false)
  telefone          String   @db.VarChar(11)
  telefoneVerificado Boolean @default(false)
  
  logradouro        String?  @db.VarChar(255)
  numero            String?  @db.VarChar(20)
  complemento       String?  @db.VarChar(100)
  bairro            String?  @db.VarChar(100)
  cidade            String?  @db.VarChar(100)
  uf                String?  @db.VarChar(2)
  cep               String?  @db.VarChar(8)
  
  senhaHash         String   @db.VarChar(255)
  salt              String   @db.VarChar(255)
  autenticacao2FA   Boolean  @default(false)
  secret2FA         String?  @db.VarChar(255)
  
  refreshToken      String?  @db.Text
  resetPasswordToken String? @db.Text
  resetPasswordExpires DateTime?
  
  biometriaAtiva    Boolean  @default(false)
  biometriaHash     String?  @db.Text
  
  consentimentoLGPD Boolean  @default(false)
  dataConsentimento DateTime?
  termosAceitos     Boolean  @default(false)
  versaoTermos      String?  @db.VarChar(20)
  
  ativo             Boolean  @default(true)
  bloqueado         Boolean  @default(false)
  tentativasLogin   Int      @default(0)
  ultimoAcesso      DateTime?
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt
  
  perfis            UsuarioPerfil[]
  gruposUsuario     UsuarioGrupo[]
  dispositivos      Dispositivo[]
  sessoes           Sessao[]
  logs              LogAuditoria[]
  documentos        Documento[]
  documentosCompartilhados DocumentoCompartilhamento[]
  tarefas           Tarefa[] @relation("TarefasAtribuidas")
  tarefasCriadas    Tarefa[] @relation("TarefasCriadas")
  mensagens         Mensagem[]
  pontosRegistrados RegistroPonto[]
  emprestimos       Emprestimo[]
  alertas           Alerta[]
  listasCompras     ListaCompras[]
  listasCompartilhadas ListaComprasCompartilhamento[]
  
  @@index([cpf])
  @@index([email])
  @@index([telefone])
  @@map("usuarios")
}

model Perfil {
  id          String   @id @default(uuid())
  codigo      String   @unique @db.VarChar(50)
  nome        String   @db.VarChar(100)
  descricao   String?  @db.Text
  cor         String   @db.VarChar(7)
  icone       String?  @db.VarChar(50)
  ativo       Boolean  @default(true)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  usuarios    UsuarioPerfil[]
  permissoes  PerfilFuncionalidade[]
  
  @@map("perfis")
}

model UsuarioPerfil {
  id          String   @id @default(uuid())
  usuarioId   String
  perfilId    String
  grupoId     String
  
  avatar      String?  @db.VarChar(10)
  apelido     String?  @db.VarChar(100)
  
  ativo       Boolean  @default(true)
  principal   Boolean  @default(false)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  perfil      Perfil   @relation(fields: [perfilId], references: [id])
  grupo       Grupo    @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, perfilId, grupoId])
  @@index([usuarioId])
  @@index([perfilId])
  @@index([grupoId])
  @@map("usuarios_perfis")
}

model Funcionalidade {
  id          String   @id @default(uuid())
  codigo      String   @unique @db.VarChar(100)
  nome        String   @db.VarChar(100)
  descricao   String?  @db.Text
  icone       String?  @db.VarChar(50)
  rota        String?  @db.VarChar(255)
  ordem       Int      @default(0)
  ativo       Boolean  @default(true)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  perfis      PerfilFuncionalidade[]
  
  @@map("funcionalidades")
}

model PerfilFuncionalidade {
  id               String   @id @default(uuid())
  perfilId         String
  funcionalidadeId String
  
  permissaoLeitura   Boolean @default(true)
  permissaoEscrita   Boolean @default(false)
  permissaoExclusao  Boolean @default(false)
  permissaoAdmin     Boolean @default(false)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  perfil          Perfil          @relation(fields: [perfilId], references: [id], onDelete: Cascade)
  funcionalidade  Funcionalidade  @relation(fields: [funcionalidadeId], references: [id], onDelete: Cascade)
  
  @@unique([perfilId, funcionalidadeId])
  @@index([perfilId])
  @@index([funcionalidadeId])
  @@map("perfis_funcionalidades")
}

model Grupo {
  id          String   @id @default(uuid())
  nome        String   @db.VarChar(255)
  descricao   String?  @db.Text
  cor         String?  @db.VarChar(7)
  icone       String?  @db.VarChar(50)
  tipo        String   @db.VarChar(50)
  privado     Boolean  @default(false)
  ativo       Boolean  @default(true)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  membros     UsuarioGrupo[]
  perfis      UsuarioPerfil[]
  mensagens   Mensagem[]
  
  @@map("grupos")
}

model UsuarioGrupo {
  id          String   @id @default(uuid())
  usuarioId   String
  grupoId     String
  
  papel       String   @db.VarChar(50)
  ativo       Boolean  @default(true)
  
  criadoEm    DateTime @default(now())
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  grupo       Grupo    @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, grupoId])
  @@index([usuarioId])
  @@index([grupoId])
  @@map("usuarios_grupos")
}

// ==========================================
// üîê TABELAS DE SEGURAN√áA
// ==========================================

model Dispositivo {
  id              String   @id @default(uuid())
  usuarioId       String
  
  dispositivoId   String   @unique @db.VarChar(255)
  nome            String?  @db.VarChar(255)
  modelo          String?  @db.VarChar(255)
  versaoSO        String?  @db.VarChar(100)
  tipo            String   @db.VarChar(50)
  
  nomeRedeWiFi    String?  @db.VarChar(255)
  enderecoIP      String?  @db.VarChar(45)
  
  latitude        Float?
  longitude       Float?
  precisao        Float?
  
  confiavel       Boolean  @default(false)
  ativo           Boolean  @default(true)
  
  ultimoUso       DateTime @default(now())
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sessoes         Sessao[]
  registrosPonto  RegistroPonto[]
  
  @@index([usuarioId])
  @@index([dispositivoId])
  @@map("dispositivos")
}

model Sessao {
  id              String   @id @default(uuid())
  usuarioId       String
  dispositivoId   String?
  
  token           String   @unique @db.Text
  refreshToken    String?  @db.Text
  
  enderecoIP      String?  @db.VarChar(45)
  userAgent       String?  @db.Text
  
  expiraEm        DateTime
  ativo           Boolean  @default(true)
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  dispositivo     Dispositivo? @relation(fields: [dispositivoId], references: [id])
  
  @@index([usuarioId])
  @@index([token])
  @@map("sessoes")
}

// ==========================================
// üìä TABELAS DE FUNCIONALIDADES
// ==========================================

/// @description CORRIGIDO: Adicionado compartilhamento estruturado
model Documento {
  id                String   @id @default(uuid())
  usuarioId         String
  
  nome              String   @db.VarChar(255)
  descricao         String?  @db.Text
  categoria         String   @db.VarChar(100)
  tipo              String   @db.VarChar(50)
  tamanho           Int
  
  caminhoArquivo    String   @db.Text
  urlPublica        String?  @db.Text
  hash              String?  @db.VarChar(255)
  
  validado          Boolean  @default(false)
  validadoEm        DateTime?
  validadoPor       String?  @db.VarChar(255)
  
  dataVencimento    DateTime?
  alertaVencimento  Boolean  @default(false)
  
  permissao         String   @db.VarChar(50)
  
  tags              String[]
  
  esocialPronto     Boolean  @default(false)
  backupCriado      Boolean  @default(false)
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt
  
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  compartilhamentos DocumentoCompartilhamento[]
  
  @@index([usuarioId])
  @@index([categoria])
  @@map("documentos")
}

/// @description NOVO: Compartilhamento de documentos
model DocumentoCompartilhamento {
  id          String   @id @default(uuid())
  documentoId String
  usuarioId   String
  permissao   String   @db.VarChar(50) @default("LEITURA")
  
  criadoEm    DateTime @default(now())
  
  documento   Documento @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  usuario     Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@unique([documentoId, usuarioId])
  @@index([documentoId])
  @@index([usuarioId])
  @@map("documentos_compartilhamento")
}

model Tarefa {
  id              String   @id @default(uuid())
  titulo          String   @db.VarChar(255)
  descricao       String?  @db.Text
  
  prioridade      String   @db.VarChar(20)
  status          String   @db.VarChar(50)
  
  atribuidoPara   String
  criadoPor       String
  
  dataVencimento  DateTime
  dataConclusao   DateTime?
  
  checklist       Json?
  
  comentarios     Json?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  responsavel     Usuario  @relation("TarefasAtribuidas", fields: [atribuidoPara], references: [id])
  criador         Usuario  @relation("TarefasCriadas", fields: [criadoPor], references: [id])
  
  @@index([atribuidoPara])
  @@index([criadoPor])
  @@index([status])
  @@map("tarefas")
}

model Mensagem {
  id          String   @id @default(uuid())
  remetenteId String
  grupoId     String?
  
  conteudo    String   @db.Text
  tipo        String   @db.VarChar(50)
  anexos      Json?
  
  lida        Boolean  @default(false)
  editada     Boolean  @default(false)
  excluida    Boolean  @default(false)
  
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  remetente   Usuario  @relation(fields: [remetenteId], references: [id], onDelete: Cascade)
  grupo       Grupo?   @relation(fields: [grupoId], references: [id])
  
  @@index([remetenteId])
  @@index([grupoId])
  @@map("mensagens")
}

/// @description CORRIGIDO: J√° tinha observa√ß√£o!
model RegistroPonto {
  id              String   @id @default(uuid())
  usuarioId       String
  dispositivoId   String
  
  dataHora        DateTime @default(now()) @db.Timestamptz
  tipo            String   @db.VarChar(50)
  
  latitude        Float
  longitude       Float
  precisao        Float
  dentroGeofence  Boolean  @default(false)
  
  enderecoIP      String   @db.VarChar(45)
  nomeRedeWiFi    String?  @db.VarChar(255)
  
  aprovado        Boolean  @default(false)
  aprovadoPor     String?  @db.VarChar(255)
  aprovadoEm      DateTime?
  
  observacao      String?  @db.Text
  
  hashIntegridade String   @db.VarChar(255)
  
  criadoEm        DateTime @default(now())
  
  usuario         Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  dispositivo     Dispositivo @relation(fields: [dispositivoId], references: [id])
  
  @@index([usuarioId])
  @@index([dataHora])
  @@index([tipo])
  @@map("registros_ponto")
}

model EventoESocial {
  id                String   @id @default(uuid())
  
  tipoEvento        String   @db.VarChar(20)
  descricao         String   @db.VarChar(255)
  
  status            String   @db.VarChar(50)
  
  dataEnvio         DateTime?
  dataProcessamento DateTime?
  protocolo         String?  @db.VarChar(255)
  versao            String?  @db.VarChar(20)
  
  xmlEnvio          String?  @db.Text
  xmlRetorno        String?  @db.Text
  
  erro              String?  @db.Text
  
  criadoEm          DateTime @default(now())
  atualizadoEm      DateTime @updatedAt
  
  @@index([tipoEvento])
  @@index([status])
  @@map("eventos_esocial")
}

model Emprestimo {
  id              String   @id @default(uuid())
  usuarioId       String
  
  valor           Decimal  @db.Decimal(10, 2)
  valorParcela    Decimal  @db.Decimal(10, 2)
  quantidadeParcelas Int
  parcelasPagas   Int      @default(0)
  
  dataConcessao   DateTime @db.Date
  dataVencimento  DateTime @db.Date
  
  status          String   @db.VarChar(50)
  
  observacao      String?  @db.Text
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@index([status])
  @@map("emprestimos")
}

model Alerta {
  id              String   @id @default(uuid())
  usuarioId       String?
  
  titulo          String   @db.VarChar(255)
  descricao       String   @db.Text
  tipo            String   @db.VarChar(50)
  prioridade      String   @db.VarChar(20)
  categoria       String   @db.VarChar(100)
  
  status          String   @db.VarChar(50)
  lido            Boolean  @default(false)
  
  dataAlerta      DateTime
  dataExpiracao   DateTime?
  
  recorrente      Boolean  @default(false)
  frequencia      String?  @db.VarChar(50)
  
  condicoes       Json?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  usuario         Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@index([tipo])
  @@index([status])
  @@map("alertas")
}

// ==========================================
// üõí GEST√ÉO DE COMPRAS - NORMALIZADO
// ==========================================

/// @description CORRIGIDO: Normalizado com tabelas separadas
model ListaCompras {
  id              String   @id @default(uuid())
  usuarioId       String
  nome            String   @db.VarChar(255)
  categoria       String   @db.VarChar(100)
  descricao       String?  @db.Text
  
  totalItens      Int      @default(0)
  itensComprados  Int      @default(0)
  valorEstimado   Decimal  @db.Decimal(10, 2)
  valorFinal      Decimal? @db.Decimal(10, 2)
  
  ativa           Boolean  @default(true)
  concluida       Boolean  @default(false)
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  itens           ItemCompra[]
  compartilhamentos ListaComprasCompartilhamento[]
  
  @@index([usuarioId])
  @@index([categoria])
  @@map("listas_compras")
}

/// @description NOVO: Itens da lista de compras (estruturado)
model ItemCompra {
  id              String   @id @default(uuid())
  listaId         String
  
  nome            String   @db.VarChar(255)
  quantidade      String   @db.VarChar(100)
  preco           Decimal? @db.Decimal(10, 2)
  categoria       String   @db.VarChar(100)
  
  comprado        Boolean  @default(false)
  compradoEm      DateTime?
  compradoPor     String?  @db.VarChar(255)
  
  observacao      String?  @db.Text
  marca           String?  @db.VarChar(100)
  local           String?  @db.VarChar(255)
  
  ordem           Int      @default(0)
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  lista           ListaCompras @relation(fields: [listaId], references: [id], onDelete: Cascade)
  
  @@index([listaId])
  @@index([comprado])
  @@index([categoria])
  @@map("itens_compra")
}

/// @description NOVO: Compartilhamento de lista de compras
model ListaComprasCompartilhamento {
  id          String   @id @default(uuid())
  listaId     String
  usuarioId   String
  permissao   String   @db.VarChar(50) @default("LEITURA")
  
  criadoEm    DateTime @default(now())
  
  lista       ListaCompras @relation(fields: [listaId], references: [id], onDelete: Cascade)
  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@unique([listaId, usuarioId])
  @@index([listaId])
  @@index([usuarioId])
  @@map("listas_compras_compartilhamento")
}

model CalculoSalarial {
  id              String   @id @default(uuid())
  cpfEmpregado    String   @db.VarChar(11)
  
  mesReferencia   Int
  anoReferencia   Int
  
  salarioBruto    Decimal  @db.Decimal(10, 2)
  descontos       Json
  proventos       Json
  salarioLiquido  Decimal  @db.Decimal(10, 2)
  
  baseINSS        Decimal  @db.Decimal(10, 2)
  valorINSS       Decimal  @db.Decimal(10, 2)
  baseIR          Decimal  @db.Decimal(10, 2)
  valorIR         Decimal  @db.Decimal(10, 2)
  
  processado      Boolean  @default(false)
  pago            Boolean  @default(false)
  dataPagamento   DateTime?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  @@unique([cpfEmpregado, mesReferencia, anoReferencia])
  @@index([cpfEmpregado])
  @@map("calculos_salariais")
}

model Termo {
  id              String   @id @default(uuid())
  
  versao          String   @unique @db.VarChar(20)
  tipo            String   @db.VarChar(50)
  
  titulo          String   @db.VarChar(255)
  conteudo        String   @db.Text
  
  ativo           Boolean  @default(true)
  
  dataVigencia    DateTime @db.Date
  dataExpiracao   DateTime? @db.Date
  
  mudancas        Json?
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  @@index([versao])
  @@map("termos")
}

// ==========================================
// üìã TABELA DE LOG E AUDITORIA (LGPD)
// ==========================================

model LogAuditoria {
  id              String   @id @default(uuid())
  usuarioId       String?
  
  acao            String   @db.VarChar(100)
  entidade        String   @db.VarChar(100)
  entidadeId      String?  @db.VarChar(255)
  
  descricao       String   @db.Text
  
  metodo          String?  @db.VarChar(20)
  rota            String?  @db.VarChar(255)
  enderecoIP      String?  @db.VarChar(45)
  userAgent       String?  @db.Text
  
  dadosAnteriores Json?
  dadosNovos      Json?
  
  sucesso         Boolean  @default(true)
  erro            String?  @db.Text
  
  tipoLog         String   @db.VarChar(50)
  nivelSeveridade String   @db.VarChar(20)
  
  criadoEm        DateTime @default(now())
  
  usuario         Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  @@index([usuarioId])
  @@index([acao])
  @@index([entidade])
  @@index([criadoEm])
  @@index([tipoLog])
  @@map("logs_auditoria")
}

model Configuracao {
  id              String   @id @default(uuid())
  
  chave           String   @unique @db.VarChar(100)
  valor           String   @db.Text
  tipo            String   @db.VarChar(50)
  
  descricao       String?  @db.Text
  categoria       String   @db.VarChar(100)
  
  ativo           Boolean  @default(true)
  sensivel        Boolean  @default(false)
  
  criadoEm        DateTime @default(now())
  atualizadoEm    DateTime @updatedAt
  
  @@index([chave])
  @@index([categoria])
  @@map("configuracoes")
}

